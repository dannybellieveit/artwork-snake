<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DannyCasio File Share</title>
  <base href="/" />
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0; background:#87CEEB; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; color:#000; }
    header { position:relative; background:#fff; padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; }
    .back-btn { position:absolute; left:1rem; top:1rem; text-decoration:none; color:#000; font-size:1rem; }
    main { max-width:800px; margin:4rem auto 2rem; background:#fff; padding:2rem; border-radius:8px; }
    .file-item { margin-bottom:1.5rem; border-bottom:1px solid #ececec; padding-bottom:1rem; }
    .file-item h2 { margin:0 0 .5rem; font-size:1.25rem; }
    .file-item audio { width:100%; margin:.5rem 0; }
    .file-item a.download { display:inline-block; margin-top:.5rem; background:#0070f3; color:#fff; padding:.5rem 1rem; border-radius:4px; text-decoration:none; }
    .file-item a.download:hover { background:#005bb5; }
  </style>
</head>
<body>
  <header>
    <a class="back-btn" href="https://dannycasio.com">← Back to Home</a>
    <h1>DannyCasio File Portal</h1>
  </header>
  <main id="drop-content">
    <p>Loading files…</p>
  </main>
  <script>
    (async () => {
      // 1) get token
      const params = new URLSearchParams(location.search);
      let token = params.get('token');
      if (!token) {
        const m = location.pathname.match(/^\/drop\/([^/]+)$/);
        token = m && m[1];
      }
      const container = document.getElementById('drop-content');
      if (!token) {
        container.innerHTML = '<p>No share token provided.</p>';
        return;
      }

      // 2) fetch the share page HTML via your Worker proxy
      let html;
      try {
        const res = await fetch(`/share-proxy/${token}`);
        html = await res.text();
      } catch (e) {
        container.innerHTML = '<p>Error loading share page.</p>';
        return;
      }

      // 3) parse out file entries
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Nextcloud public-share uses list items under .files-list__tbody
      const rows = doc.querySelectorAll('.files-list__tbody .files-list__row');
      if (!rows.length) {
        container.innerHTML = '<p>No files found.</p>';
        return;
      }
      container.innerHTML = '';

      rows.forEach(row => {
        const nameBtn = row.querySelector('.files-list__row-name-link');
        const name = nameBtn.textContent.trim();
        const downloadAction = row.querySelector('#download--link') ||
                               row.querySelector('.public-page-menu__entry--download a');
        let url = downloadAction && downloadAction.href;
        if (!url) {
          // fallback to direct link
          const direct = row.querySelector('#directLink--link');
          url = direct && direct.href;
        }
        if (!url) return; // skip if no link

        const section = document.createElement('section');
        section.className = 'file-item';
        const h2 = document.createElement('h2');
        h2.textContent = name;
        section.appendChild(h2);

        // if audio
        if (name.match(/\.(mp3|wav|ogg)$/i)) {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = url;
          section.appendChild(audio);
        }

        const a = document.createElement('a');
        a.className = 'download';
        a.href = url;
        a.textContent = 'Download';
        a.setAttribute('download', name);
        section.appendChild(a);

        container.appendChild(section);
      });
    })();
  </script>
</body>
</html>
