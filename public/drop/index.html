<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Danny Casio File Share</title>
  <base href="/" />
  <link rel="stylesheet" href="style.css">
  <style>
 /* Danny Casio – minimal transfer page */
:root{
  --blue: #0070f3;            /* the same bright-blue you use for links */
  --bg  : #87CEEB;            /* sky-blue site background */
}

html,body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  color:#000;
}

/* slim header – transparent so the sky-blue shows through */
header{
  position:relative;
  padding:1.2rem 1rem 0;
  text-align:center;
}
.back-btn{
  position:absolute;left:1rem;top:1rem;
  text-decoration:none;color:#000;font-size:1rem;
}
header h1{
  margin:0;
  font-size:clamp(1.6rem,4vw,2.2rem);
  font-weight:700;
  letter-spacing:.02em;
}

/* the list itself */
#drop-content{
  max-width:900px;
  margin:3.5rem auto 2.5rem;
  padding:0 1rem;
  display:grid;
  gap:2.2rem;
}

/* each file = simple line-item (no white box) */
.file-item{
  padding-bottom:.5rem;
  border-bottom:2px solid rgba(0,0,0,.15);  /* subtle divider */
}
.file-item h2{
  margin:0;
  font-size:1.15rem;
  font-weight:600;
  word-break:break-all;
}
.file-item audio{
  width:100%;
  margin:.6rem 0 1.1rem;
  outline:none;
  border-radius:8px;
}

/* blue download button */
.download{
  display:inline-block;
  background:var(--blue);
  color:#fff;
  text-decoration:none;
  padding:.55rem 1.3rem;
  border-radius:10px;
  font-weight:600;
  transition:background .15s ease;
}
.download:hover{ background:#005bb5; }

/* phone tweaks */
@media(max-width:600px){
  #drop-content{ gap:1.4rem; }
}

  </style>
</head>
<body>
  <nav class="top-links">
    <a href="https://dannycasio.com" class="home-link">Home</a>
  </nav>
<main id="drop-content" class="portal">
  <!-- JS will fill this -->
</main>

<script>
(async () => {
  /* 1. token */
  const qs  = new URLSearchParams(location.search);
  let token = qs.get('token') || (location.pathname.match(/^\/drop\/([^/]+)$/)||[])[1];
  const box = document.getElementById('drop-content');
  if (!token){ box.textContent = 'No share token provided.'; return; }

  /* helper: build one card */
  function render(name, url, mime=''){
    const wrap = document.createElement('section');
    wrap.className = 'file-item';
    wrap.innerHTML =
      `<h2>${name}</h2>` +
      (/^audio\//.test(mime) || /\.(mp3|wav|ogg)$/i.test(name)
         ? `<audio controls src="${url}"></audio>` : '') +
      `<a class="download" href="${url}" download>Download</a>`;
    box.appendChild(wrap);
  }

  /* 2. fetch XML list */
  let xmlText = '';
  try{
    const res = await fetch(`/list-proxy/${token}`);
    if(!res.ok) throw new Error(res.status);
    xmlText = await res.text();
  }catch(e){ box.textContent='Error loading files.'; console.error(e); return; }

  const doc  = new DOMParser().parseFromString(xmlText,'application/xml');
  const all  = [...doc.getElementsByTagName('*')].filter(n=>n.localName==='response');

  /* 3. normal multi-file share */
  const files = all.filter(r=>{
    const href = r.getElementsByTagNameNS('*','href')[0]?.textContent || '';
    return !href.endsWith('/webdav/') && !href.endsWith('/');
  });

  box.innerHTML = '';

  if (files.length){
    files.forEach(r=>{
      const href = r.getElementsByTagNameNS('*','href')[0].textContent;
      const name = decodeURIComponent(href.split('/').filter(Boolean).pop());
      const url  = `https://transfer.dannycasio.com/s/${token}/download?path=/${encodeURIComponent(name)}`;
      render(name, url);
    });
    return;
  }

  /* 4. single-file share -> ask head-proxy for filename + mime */
  try{
    const meta = await fetch(`/head-proxy/${token}`).then(r=>r.json());
    const url  = `https://transfer.dannycasio.com/s/${token}/download`;
    render(meta.filename || 'file', url, meta.mime);
  }catch(err){
    /* fallback: still show a basic link */
    const url = `https://transfer.dannycasio.com/s/${token}/download`;
    render('file', url);
  }
})();
</script>



</body>
</html>
