<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Danny Casio File Share</title>
  <base href="/" />
  <link rel="stylesheet" href="/style.css">
  <style>
    :root { --blue:#0070f3; }
    body   { margin:0; background:#87CEEB; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; color:#000; }
    /* simple header strip */
    header { padding:1.2rem 1rem 0; text-align:center; }
    header h1 { margin:0; font-size:clamp(1.6rem,4vw,2.4rem); }
    .back-btn { position:absolute; left:1rem; top:1rem; text-decoration:none; color:#000; font-size:1rem; }
    /* file list grid */
    #drop-content { max-width:900px; margin:2.5rem auto; display:grid; gap:2rem; padding:0 1rem; }
    .file-card   { background:#fff; padding:1.5rem 2rem; border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .file-card h2{ margin:0 0 .75rem; font-size:1.25rem; word-break:break-all; }
    .file-card audio{ width:100%; margin:.5rem 0 1rem; }
    .download    { display:inline-block; background:var(--blue); color:#fff; text-decoration:none; padding:.6rem 1.3rem; border-radius:8px; font-weight:600; }
    .download:hover{ background:#005bb5; }
    /* mobile spacing */
    @media (max-width:600px){ #drop-content{ gap:1.25rem; } }
  </style>
</head>
<body>
  <header>
    <a class="back-btn" href="https://dannycasio.com">← Back to Home</a>
    <h1>DannyCasio File Portal</h1>
  </header>

  <div id="drop-content">Loading…</div>

  <script>
  (async () => {
    /* -------- 1. grab token -------- */
    const qs  = new URLSearchParams(location.search);
    let token = qs.get('token') || (location.pathname.match(/^\/drop\/([^/]+)$/)||[])[1];
    const box = document.getElementById('drop-content');
    if (!token){ box.textContent='No share token provided.'; return; }

    /* -------- 2. fetch XML list via Worker -------- */
    let xmlText;
    try{
      const res = await fetch(`/list-proxy/${token}`);
      if(!res.ok) throw new Error(res.status);
      xmlText = await res.text();
    }catch(e){ box.textContent='Error loading files.'; console.error(e); return; }

    /* -------- 3. parse responses, skip folder itself -------- */
    const xml = new DOMParser().parseFromString(xmlText,'application/xml');
    const all = [...xml.getElementsByTagName('*')].filter(n=>n.localName==='response');

    const files = all.filter(r => {
      const href = r.getElementsByTagName('*')[0].textContent;
      return !href.endsWith('/webdav/') && !href.endsWith('/');   // ignore root folder
    });

    if(!files.length){ box.textContent='No files found.'; return; }
    box.innerHTML='';

    /* -------- 4. render each card -------- */
    files.forEach(r=>{
      const href = r.getElementsByTagName('*')[0].textContent;
      const name = decodeURIComponent(href.split('/').filter(Boolean).pop());
      const url  = `https://transfer.dannycasio.com/s/${token}/download?path=/${encodeURIComponent(name)}`;
      const card = document.createElement('div');
      card.className='file-card';
      card.innerHTML = `
        <h2>${name}</h2>
        ${/\.(mp3|wav|ogg|flac)$/i.test(name)?`<audio controls src="${url}"></audio>`:''}
        <a class="download" href="${url}" download>Download</a>
      `;
      box.appendChild(card);
    });
  })();
  </script>
</body>
</html>
