  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>File Share</title>
  <base href="/" />
  <link rel="stylesheet" href="/style.css"><!-- keep any global styles -->
  <style>
  /* ====== Danny Casio transfer page – minimal, on-brand ====== */
  :root{
    --bg      : #87CEEB;   /* site sky-blue */
    --btn     : #5AB4E5;   /* slightly darker than bg */
    --btn-dk  : #3F93C8;   /* hover */
  }

  html,body{
    margin:0;
    background:var(--bg);
    color:#000;
  }

  /* slim header */
  header{
    position:relative;
    padding:1.2rem 1rem 0;
    text-align:center;
  }
  .back-btn{
    position:absolute; left:1rem; top:1rem;
    text-decoration:none; color:#000; font-size:1rem;
  }
  header h1{
    margin:0;
    font-size:clamp(1.6rem,4vw,2.2rem);
    font-weight:700;
    letter-spacing:.02em;
  }

  /* list container */
  #drop-content{
    max-width:900px;
    margin:3.5rem auto 2.5rem;
    padding:0 1rem;
    display:grid;
    gap:2rem;
  }

  /* each item – no white box, just spacing */
  .file-item h2{
    margin:0 0 .7rem;
    font-size:1.15rem;
    font-weight:600;
    word-break:break-all;
  }
  .wave-player{
    width:100%;
    margin:.6rem 0 1.1rem;
  }
  .wave-player .play-btn{
    display:block;
    width:100%;
    text-align:center;
    background:var(--btn);
    color:#fff;
    border:none;
    padding:.55rem 0;
    border-radius:8px;
    font-weight:600;
    margin-top:.4rem;
    cursor:pointer;
  }
  .wave-player .play-btn:hover{ background:var(--btn-dk); }

  /* full-width download button */
  .download{
    display:block;
    width:100%;
    text-align:center;
    background:var(--btn);
    color:#fff;
    text-decoration:none;
    padding:.65rem 0;
    border-radius:10px;
    font-weight:600;
    transition:background .15s ease;
  }
  .download:hover{ background:var(--btn-dk); }

  /* Snake container should blend into the page */
  .game-container.no-border{
    border:none;
  }

  /* footer links */
  footer{
    text-align:center;
    margin:3rem 0 2rem;
    font-size:.95rem;
  }

  @media(max-width:600px){
    #drop-content{ gap:1.4rem; }
  }
  </style>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script>
  let activePlayer = null;
  function initWaveSurfer(container, source){
    if (!window.WaveSurfer) {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.style.display = 'block';
      audio.style.width = '100%';
      if (typeof source === 'string') {
        audio.src = source;
      } else if (source instanceof AudioBuffer) {
        audio.src = URL.createObjectURL(bufferToWaveBlob(source));
      }
      container.appendChild(audio);
      return;
    }

    const waveEl = document.createElement('div');
    container.appendChild(waveEl);
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = 'Play';
    container.appendChild(btn);

    const styles = getComputedStyle(document.documentElement);
    const dark  = styles.getPropertyValue('--btn-dk').trim() || '#000';

    const ws = WaveSurfer.create({
      container: waveEl,
      waveColor: '#000',
      progressColor: dark,
      height: 64,
      responsive: true
    });

    if (typeof source === 'string') {
      ws.load(source);
    } else if (source instanceof AudioBuffer) {
      ws.loadDecodedBuffer(source);
    }

    ws.on('finish', () => {
      if (activePlayer && activePlayer.wave === ws) {
        activePlayer.btn.textContent = 'Play';
        activePlayer = null;
      }
    });

    btn.addEventListener('click', () => {
      if (activePlayer && activePlayer.wave !== ws) {
        activePlayer.wave.pause();
        activePlayer.btn.textContent = 'Play';
      }

      if (ws.isPlaying()) {
        ws.pause();
        btn.textContent = 'Play';
        activePlayer = null;
      } else {
        ws.play();
        btn.textContent = 'Pause';
        activePlayer = { wave: ws, btn };
      }
    });
  }

  function makeDemoBuffer(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const dur = 1.2;
    const len = Math.floor(ctx.sampleRate * dur);
    const buf = ctx.createBuffer(1, len, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<len;i++){
      const t=i/ctx.sampleRate;
      data[i]=Math.sin(2*Math.PI*220*t)*Math.pow(1-t/dur,2)*0.5;
    }
    ctx.close();
    return buf;
  }

  function bufferToWaveBlob(buf){
    const num = buf.numberOfChannels;
    const len = buf.length * num * 2 + 44;
    const ab  = new ArrayBuffer(len);
    const view = new DataView(ab);
    let offset = 0;
    function writeString(s){ for(let i=0;i<s.length;i++) view.setUint8(offset++, s.charCodeAt(i)); }
    function write16(v){ view.setUint16(offset, v, true); offset += 2; }
    function write32(v){ view.setUint32(offset, v, true); offset += 4; }
    writeString('RIFF');
    write32(len - 8);
    writeString('WAVE');
    writeString('fmt ');
    write32(16);           // PCM chunk size
    write16(1);            // format: PCM
    write16(num);
    write32(buf.sampleRate);
    write32(buf.sampleRate * num * 2);
    write16(num * 2);
    write16(16);
    writeString('data');
    write32(buf.length * num * 2);
    for(let i=0;i<buf.length;i++){
      for(let ch=0; ch<num; ch++){
        let sample = buf.getChannelData(ch)[i];
        sample = Math.max(-1, Math.min(1, sample));
        sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
        view.setInt16(offset, sample, true);
        offset += 2;
      }
    }
    return new Blob([ab], {type:'audio/wav'});
  }
  </script>
</head>
<body>



  <div id="drop-content">Loading…</div>

  <!---- keep your existing <script> block exactly as-is here ---->

  <!-- footer with email & Instagram -->
  <footer>
    <ul class="contacts">
      <li><a href="mailto:dannycasio@me.com">Email</a></li>
      <li><a href="https://instagram.com/dannycasio_" target="_blank" rel="noopener">Instagram</a></li>
      <li><a id="more-btn" href="#">More</a></li>
    </ul>
  </footer>



<script>
(async () => {
  /* 1. token */
  const qs  = new URLSearchParams(location.search);
  let token = qs.get('token') || (location.pathname.match(/^\/drop\/([^/]+)$/)||[])[1];
  const box = document.getElementById('drop-content');

  /* helper: build one card */
function render(name, source, mime='', bytes=0){
  const wrap = document.createElement('section');
  wrap.className = 'file-item';

  const h2 = document.createElement('h2');
  h2.textContent = name;
  wrap.appendChild(h2);

  const isAudio = /^audio\//.test(mime) || /\.(mp3|wav|ogg)$/i.test(name);
  let waveTarget = null;
  if (isAudio) {
    const player = document.createElement('div');
    player.className = 'wave-player';
    wrap.appendChild(player);
    waveTarget = player;
  }

  if (typeof source === 'string' && source) {
    const dl = document.createElement('a');
    dl.className = 'download';
    dl.href = source;
    dl.download = '';
    dl.textContent = 'Download';
    wrap.appendChild(dl);
  }

  if (bytes) {
    const size = document.createElement('div');
    size.style.fontSize = '.9rem';
    size.style.marginTop = '.4rem';
    size.textContent = `Size: ${(bytes/(1024*1024)).toFixed(1)} MB`;
    wrap.appendChild(size);
  }

  box.appendChild(wrap);
  if (waveTarget) initWaveSurfer(waveTarget, source);
}

  const demoMode = qs.get('demo') === '1';
  if (!token) {
    if (demoMode) {
      render('Demo Audio', makeDemoBuffer(), 'audio/wav');
    } else {
      box.textContent = 'No share token provided.';
    }
    return;
  }
  document.title = 'File Share';

  /* 2. fetch XML list */
  let xmlText = '';
  try{
    const res = await fetch(`/list-proxy/${token}`);
    if(!res.ok) throw new Error(res.status);
    xmlText = await res.text();
  }catch(e){ box.textContent='Error loading files.'; console.error(e); return; }

  const doc  = new DOMParser().parseFromString(xmlText,'application/xml');
  const all  = [...doc.getElementsByTagName('*')].filter(n=>n.localName==='response');

  /* 3. normal multi-file share */
  const files = all.filter(r=>{
    const href = r.getElementsByTagNameNS('*','href')[0]?.textContent || '';
    return !href.endsWith('/webdav/') && !href.endsWith('/');
  });

  if (files.length === 1) {
    const href = files[0].getElementsByTagNameNS('*','href')[0].textContent;
    const name = decodeURIComponent(href.split('/').filter(Boolean).pop());
    document.title = name;
  }

  box.innerHTML = '';

/* ---------- 4A. Folder share ---------- */
if (files.length) {
  /* 1. Build a bullet list of filenames and total size */
  const listWrap = document.createElement('section');
  listWrap.className = 'file-item';

  const ul = document.createElement('ul');
  ul.style.margin  = '0 0 1.2rem 1.2rem';
  ul.style.padding = '0';

  let totalBytes = 0;               // accumulate here

  files.forEach(r => {
  /* filename + direct download URL */
  const href = r.getElementsByTagNameNS('*','href')[0].textContent;
  const name = decodeURIComponent(href.split('/').filter(Boolean).pop());
const fileURL = `/share-proxy/${token}?file=${encodeURIComponent(name)}`;

  /* <li> item */
  const li = document.createElement('li');
  li.appendChild(document.createTextNode(name));

  /* if it’s audio, add inline player */
  let liWaveTarget = null;
  if (/\.(mp3|wav|ogg|flac)$/i.test(name)) {
    const player = document.createElement('div');
    player.className = 'wave-player';
    li.appendChild(player);
    liWaveTarget = player;
  }

  ul.appendChild(li);
  if (liWaveTarget) initWaveSurfer(liWaveTarget, fileURL);

  /* size accumulator */
  const lenNode = r.getElementsByTagNameNS('*','getcontentlength')[0];
  if (lenNode) totalBytes += Number(lenNode.textContent || 0);
});


  listWrap.appendChild(ul);

  /* 2. Single “Download all (ZIP)” button */
  const zipURL = `https://transfer.dannycasio.com/s/${token}/download?accept=zip`;
  const btn = document.createElement('a');
  btn.className = 'download';
  btn.href      = zipURL;
  btn.textContent = 'Download all (ZIP)';
  listWrap.appendChild(btn);

  /* 3. Size footnote */
  if (totalBytes) {
    const sizeMB = (totalBytes / (1024 * 1024)).toFixed(1);
    const note   = document.createElement('div');
    note.style.fontSize  = '.9rem';
    note.style.marginTop = '.4rem';
    note.textContent     = `Total size: ${sizeMB} MB`;
    listWrap.appendChild(note);
  }

  /* add the assembled section to the page & stop */
  box.appendChild(listWrap);
  return;
}


  /* 4. single-file share -> ask head-proxy for filename + mime */
  try{
    const meta = await fetch(`/head-proxy/${token}`).then(r=>r.json());
    const url  = `https://transfer.dannycasio.com/s/${token}/download`;
    if (meta.filename) document.title = meta.filename;
   render(meta.filename || 'file', url, meta.mime, meta.size || 0);
  }catch(err){
    /* fallback: still show a basic link */
    const url = `https://transfer.dannycasio.com/s/${token}/download`;
  render('file', url);
  }
})();
</script>

<script>
function loadScript(src){
  return new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = res;
    s.onerror = rej;
    document.body.appendChild(s);
  });
}

document.getElementById('more-btn').addEventListener('click', async e => {
  const btn = e.currentTarget;
  if (btn.dataset.loaded) return;
  e.preventDefault();
  const container = document.createElement('div');
  container.className = 'game-container no-border';
  container.innerHTML = `\
    <div id="score" class="score-label">Score: 0</div>\
    <div id="high-score" class="score-label">High Score: 0</div>\
    <canvas id="game-canvas" width="800" height="450"></canvas>\
    <div id="pause-overlay" class="pause-overlay"></div>`;
  document.body.insertBefore(container, document.getElementById('drop-content'));
  container.scrollIntoView({ behavior: 'smooth' });
  await loadScript('/images-data.js');
  await loadScript('/game.js');
  btn.textContent = 'Even more';
  btn.href = '/more.html';
  btn.dataset.loaded = '1';
});
</script>



</body>
</html>
